<!doctype html>
<html>
   <head>
      <meta charset="utf-8">
      <style>      
         body {
            display: grid;
            grid-template-columns: 1fr 1fr;
         }
               
         #lista{
            color: black;
         }
         
         #lista .temas{
            color: black;
         }
         
         #lista .problemas{
            color: black;
         }
         
         #lista .problemas span{
            margin-right: 20px;
         }
         
         #lista .tags{
            color: black;
            font-size: 12px;
         }
         
         #lista.ocultar_tags .tags {         
            display: none;
         }
      </style>
      <script src="base/ajax.js"></script>
      <script src="base/drop.js"></script>
      <script src="base/map.js"></script>
   </head>
   <body>      
      <div id="ver">
         <input type="checkbox" id="cb_tags" checked>Mostrar tags<br><br>
         Ver problemas de: <select id="select"></select>
         <ul id="lista"></ul>
      </div>
      <div id="migrar">
         Arrastrar problema a:
         <ul id="lista_migrar"></ul>
      </div>
      <script>
         document.getElementById('cb_tags').onchange = function( ) {
            document.getElementById("lista").classList.toggle("ocultar_tags");
         }
         
         // el <ul> principal es de temas de la uea seleccionada
         // cada <li> de ese <ul> representa un tema
         // cada <li> de tema tiene su propio <ul> con los problemas de la uea
         
         async function actualiza_db( ) {
            let lista = document.getElementById("lista");
            for (let i = 0; i < lista.childNodes.length ; ++i) {
               let arr = [ ];
               if (lista.childNodes[i].nodeType == Node.ELEMENT_NODE) {   
                  let lista_problemas = lista.childNodes[i].lastChild;
                  for (let j = 0; j < lista_problemas.childNodes.length; ++j) {
                     if (lista_problemas.childNodes[j].nodeType == Node.ELEMENT_NODE) { 
                        arr.push(lista_problemas.childNodes[j].id_db);
                     }
                  }
                  let res = await ajax_post("reordena_problemas.php", { "arr": JSON.stringify(arr) } , 1000);      
                  if (res instanceof Error) {
                     window.alert("Error al recibir respuesta del servidor.");
                  }
               }
            }
         }
         
         function crea_problema(problema, tags_por_id) {
            let problema_li = document.createElement("li");
            let problema_span = document.createElement("span");
            let problema_a = document.createElement("a");
            let tag_div = document.createElement("div");
            problema_li.setAttribute("class", "problemas");
            problema_li.id = `problemas_${problema.id}`; 
            problema_li.id_db = problema.id;
            problema_li.appendChild(problema_span);
            problema_li.appendChild(problema_a);
            problema_li.appendChild(tag_div);
            problema_span.textContent = problema.nombre;
            problema_a.href = `https://omegaup.com/arena/problem/${problema.alias}`;
            problema_a.textContent = problema.alias;
            habilita_drag(problema_li, "problema");
            habilita_drop_hermano(problema_span, "problema", problema_li, actualiza_db);
            tag_div.setAttribute("class", "tags");          
            for (let tag_id of problema.tags) { 
               tag_div.textContent += `${tags_por_id[tag_id].traduccion}, `;
            }
            return problema_li;
         }
         
         function crea_tema(tema, problemas, tags_por_id) {
            let tema_li = document.createElement("li");
            let tema_span = document.createElement("span");
            let problemas_ul = document.createElement("ul");
            tema_li.ul_anidado = problemas_ul;
            tema_li.setAttribute("class", "temas");
            tema_li.appendChild(tema_span);
            tema_li.appendChild(problemas_ul);
            tema_span.textContent = tema.nombre;
            habilita_drop_hijo(tema_span, "problema", problemas_ul);
            for (let problema of problemas) {
               problemas_ul.appendChild(crea_problema(problema, tags_por_id));
            }
            return tema_li;
         }
         
         window.onload = async function( ) {
            let ueas = await ajax_post("ueas.php", { }, 1000), temas = await ajax_post("temas.php", { }, 1000), problemas = await ajax_post("problemas.php", { }, 1000), tags = await ajax_post("tags.php", { }, 1000);
            if (ueas instanceof Error || temas instanceof Error || problemas instanceof Error || tags instanceof Error) {
               return window.alert("Error al recibir respuesta del servidor.");
            }
            
            let temas_por_id = reorganiza(temas, "id", true), problemas_por_id = reorganiza(problemas, "id", true), tags_por_id = reorganiza(tags, "id", true);
            let temas_por_uea = reorganiza(temas, "uea", false), problemas_por_tema = reorganiza(problemas, "tema", false);
            let actualiza_lista = function(uea_id) {
               document.getElementById("lista").innerHTML = "";
               for (let tema of temas_por_uea[uea_id]) {                
                  document.getElementById("lista").appendChild(crea_tema(tema, (problemas_por_tema[tema.id] ?? [ ]), tags_por_id));
               }
            };
            
            let select = document.getElementById("select"), migrar_ul = document.getElementById("lista_migrar");
            for (let uea of ueas) {
               let migrar_li = document.createElement("li");
               migrar_li.textContent = uea.nombre;
               migrar_ul.appendChild(migrar_li);
               habilita_drop(migrar_li, "problema", function(problema_li) {
                  let problema = problemas_por_id[problema_li.id_db];
                  if (uea.id != temas_por_id[problema.tema].uea) {
                     problemas_por_tema[problema.tema].splice(problemas_por_tema[problema.tema].findIndex(actual => actual.id == problema.id), 1);
                     problema.tema = temas_por_uea[uea.id].find(actual => actual.nombre == "Sin clasificaci칩n").id;    // cambiando el tema del problema por el de "Sin clasificaci칩n" de la nueva uea (por hacer, reflejar en la base de datos)
                     problemas_por_tema[problema.tema].push(problema);
                     problema_li.remove( );
                     // al llegar aqui, el id del problema est치 en problema.id y el nuevo tema ya est치 en problema.tema
                  }
               });
               select.options.add(new Option(uea.nombre, uea.id));
            }
            select.onchange = function( ) {
               actualiza_lista(this.value);
            }
            select.onchange( );
         }
      </script>
   </body>
</html>
