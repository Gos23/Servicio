<!doctype html>
<html>
   <head>
      <meta charset="utf-8">
      <style>
         #lista{
            color: black;
         }
         
         #lista .temas{
            color: black;
         }
         
         #lista .problemas{
            color: black;
         }
         
         #lista .tags{
            color: black;
         }
         
         #lista.ocultar_tags .tags {         
            display: none;
         }
         
         #lista.ocultar_temas .temas {         
            display: none;
         }
         
         #lista.ocultar_problemas .problemas {         
            display: none;
         }
      </style>
      <script src="base/ajax.js"></script>
      <script src="base/drop.js"></script>
      <script src="base/map.js"></script>
   </head>
   <body>      
      <input type="checkbox" id="cb_temas" checked>Mostrar temas<br><br>
      <input type="checkbox" id="cb_problemas" checked>Mostrar problemas<br><br>
      <input type="checkbox" id="cb_tags" checked>Mostrar tags<br><br>
      <select id="select"></select>
      <ul id="lista"></ul>
      <script>
         document.getElementById('cb_tags').onchange = function( ) {
            document.getElementById("lista").classList.toggle("ocultar_tags");
         }
         
         document.getElementById('cb_temas').onchange = function( ) {
            document.getElementById("lista").classList.toggle("ocultar_temas");
         }
         
         document.getElementById('cb_problemas').onchange = function( ) {
            document.getElementById("lista").classList.toggle("ocultar_problemas");
         }
         
         window.onload = async function( ) {
            let ueas = await ajax_post("ueas.php", { }, 1000), temas = await ajax_post("temas.php", { }, 1000), tags = await ajax_post("tags.php", { }, 1000), problemas = await ajax_post("problemas.php", { }, 1000);
            if (ueas instanceof Error || temas instanceof Error || tags instanceof Error || problemas instanceof Error) {
               return window.alert("Error al recibir respuesta del servidor.");
            }
            
            let ueas_por_id = reorganiza(ueas, "id", true), tags_por_id = reorganiza(tags, "id", true);
            let temas_por_uea = reorganiza(temas, "uea", false), problemas_por_tema = reorganiza(problemas, "tema", false);
            let actualiza_lista = function(uea_id) {
               console.clear( );
               let ul_uea = document.getElementById("lista");               
               let li_uea = document.createElement("li");
               li_uea.textContent = `${ueas_por_id[uea_id].nombre} `;
               ul_uea.appendChild(li_uea);
               
               for (let tema of temas_por_uea[uea_id]) {                
                  let ul_tema = document.createElement("ul")
                  ul_tema.setAttribute("class", "temas")
                  ul_tema.textContent = `${tema.nombre}` ;
                  li_uea.appendChild(ul_tema);
                 
                  for (let problema of (problemas_por_tema[tema.id] ?? [ ])) {
                     let li_problema = document.createElement("ul")
                     li_problema.setAttribute("class", "problemas")
                     li_problema.textContent = `${problema.nombre}` ;
                     ul_tema.appendChild(li_problema);
                                 
                     let li_tag = document.createElement("ul")
                     li_tag.setAttribute("class", "tags")              
                     for (let tag_id of problema.tags) { 
                        li_tag.textContent += ` ${tags_por_id[tag_id].traduccion}, ` ;
                     }
                     li_problema.appendChild(li_tag);
                  }
               }
            };
            
            let select = document.getElementById("select");
            for (let uea of ueas) {
               select.options.add(new Option(uea.nombre, uea.id));         
            }
            select.onchange = function( ) {
               document.getElementById("lista").innerHTML = '';
               actualiza_lista(this.value);
            }
            select.onchange( );
         }
      </script>     
   </body>
</html>
